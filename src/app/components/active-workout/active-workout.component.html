<div class="active-workout-container">
  <!-- Header with workout timer -->
  <div class="workout-header">
    <button mat-icon-button (click)="goBack()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>

    @if (workoutTemplate(); as template) {
      <div class="header-info">
        <h1 class="workout-name">{{ template.name }}</h1>
        <div class="workout-timer">{{ formatTime(elapsedTime()) }}</div>
      </div>
    }
  </div>

  <!-- Pre-Workout State -->
  @if (!isWorkoutActive()) {
    <div class="pre-workout">
      @if (workoutTemplate(); as template) {
        <div class="workout-preview">
          <h2>Ready to start?</h2>
          <div class="exercise-list">
            @for (exercise of template.exercises; track exercise.id; let i = $index) {
              <div class="exercise-preview-item">
                <div class="exercise-number">{{ i + 1 }}</div>
                <div class="exercise-info">
                  <div class="exercise-name">{{ exercise.name }}</div>
                  <div class="exercise-details">
                    {{ exercise.sets }}×{{ exercise.reps || exercise.duration + 's' }}
                    @if (exercise.weight) {
                      {{ exercise.weight }}lb
                    }
                  </div>
                </div>
              </div>
            }
          </div>
          <button mat-raised-button color="primary" class="start-button" (click)="startWorkout()">
            <mat-icon>play_arrow</mat-icon>
            Start Workout
          </button>
        </div>
      }
    </div>
  }

  <!-- Active Workout State -->
  @if (isWorkoutActive() && !isWorkoutComplete()) {
    <div class="active-workout-content">
      <!-- Exercise List with Set Circles -->
      @if (workoutTemplate(); as template) {
        <div class="exercises-list">
          @for (exercise of template.exercises; track exercise.id; let exerciseIndex = $index) {
            <div class="exercise-card"
                 [class.current]="currentExerciseIndex() === exerciseIndex">
              <div class="exercise-header">
                <div class="exercise-title">
                  <div class="exercise-name">{{ exercise.name }}</div>
                  <div class="exercise-target">
                    {{ exercise.sets }}×{{ exercise.reps || (exercise.duration + 's') }}
                    @if (exercise.weight) {
                      {{ exercise.weight }}lb
                    }
                  </div>
                </div>
              </div>

              <!-- Set Tracking Circles (StrongLifts style) -->
              <div class="set-circles">
                @for (setIndex of getExerciseSets(exercise); track setIndex) {
                  <div class="set-circle"
                       [class.completed]="isSetCompleted(exercise, setIndex)"
                       [class.current]="isCurrentSet(exerciseIndex, setIndex)">
                    {{ setIndex + 1 }}
                  </div>
                }
              </div>

              <!-- Current Set Input (only show for current exercise) -->
              @if (currentExerciseIndex() === exerciseIndex && !isRestPeriod()) {
                <div class="set-input-section">
                  <div class="input-row">
                    @if (exercise.reps || currentSet().reps !== undefined) {
                      <mat-form-field appearance="outline">
                        <mat-label>Reps</mat-label>
                        <input matInput type="number" [(ngModel)]="currentSet().reps" min="1">
                      </mat-form-field>
                    }

                    @if (exercise.weight || currentSet().weight !== undefined) {
                      <mat-form-field appearance="outline">
                        <mat-label>Weight</mat-label>
                        <input matInput type="number" [(ngModel)]="currentSet().weight" min="0" step="5">
                        <span matTextSuffix>lbs</span>
                      </mat-form-field>
                    }

                    @if (exercise.duration || currentSet().duration !== undefined) {
                      <mat-form-field appearance="outline">
                        <mat-label>Duration</mat-label>
                        <input matInput type="number" [(ngModel)]="currentSet().duration" min="1">
                        <span matTextSuffix>sec</span>
                      </mat-form-field>
                    }
                  </div>

                  @if (exercise.notes) {
                    <div class="exercise-notes">
                      <mat-icon>info</mat-icon>
                      <span>{{ exercise.notes }}</span>
                    </div>
                  }

                  <button mat-raised-button color="primary" class="complete-set-btn" (click)="completeSet()">
                    <mat-icon>check</mat-icon>
                    Complete Set
                  </button>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Rest Timer Overlay (StrongLifts style) -->
      @if (isRestPeriod()) {
        <div class="rest-timer-overlay">
          <app-rest-timer
            [restDuration]="restTimeRemaining()"
            [autoStart]="true"
            (timerComplete)="onRestTimerComplete()"
            (timerDismissed)="onRestTimerDismissed()">
          </app-rest-timer>
        </div>
      }

      <!-- Bottom Controls -->
      <div class="bottom-controls">
        @if (isPaused()) {
          <button mat-fab color="primary" (click)="resumeWorkoutFromPause()">
            <mat-icon>play_arrow</mat-icon>
          </button>
        } @else {
          <button mat-fab (click)="pauseWorkout()" class="pause-btn">
            <mat-icon>pause</mat-icon>
          </button>
        }

        <button mat-fab color="warn" (click)="finishWorkout()">
          <mat-icon>stop</mat-icon>
        </button>
      </div>
    </div>
  }

  <!-- Workout Complete State -->
  @if (isWorkoutComplete()) {
    <div class="workout-complete">
      <div class="complete-content">
        <mat-icon class="complete-icon">emoji_events</mat-icon>
        <h2>Workout Complete!</h2>
        <div class="completion-stats">
          <div class="stat">
            <span class="stat-label">Duration</span>
            <span class="stat-value">{{ formatTime(elapsedTime()) }}</span>
          </div>
          <div class="stat">
            <span class="stat-label">Sets Completed</span>
            <span class="stat-value">{{ completedSets() }}</span>
          </div>
        </div>
        <button mat-raised-button color="primary" (click)="finishWorkout()">
          <mat-icon>done</mat-icon>
          Finish Workout
        </button>
      </div>
    </div>
  }
</div>
